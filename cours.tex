\documentclass{article}
\usepackage{pktxdiag}
\usepackage[francais]{babel}
\usepackage[T1]{fontenc}
\usepackage{a4wide}
%\usepackage{cours}
\usepackage{float}
\usepackage{subfig}

\newenvironment{fpktxdiag}[2][]{\begin{figure}[H]\centering\begin{pktxdiag}[#1]\gdef\mycap{#2}}
{\end{pktxdiag}\caption{\mycap}\end{figure}}

\newenvironment{fhpktxdiag}[2][]{\begin{figure}[H]\centering\begin{hpktxdiag}[#1]\gdef\mycap{#2}}
{\end{hpktxdiag}\caption{\mycap}\end{figure}}

\begin{document}


\pgfkeys{/pktxd/timerleftbottomup}

\section{NE321}

\subsection{Stop and wait}

\begin{figure}[H]
\begin{pktxdiag}
  \ABtimed{DATA}{3cm}{temporisateur}
  \BAcancel{ACK}
\end{pktxdiag}
\hfill
\begin{pktxdiag}
  \ABtimed{DATA}{3cm}{temporisateur}
  \BA[lost]{ACK}
  \Awaittimer
  \ABtimed{DATA}{3cm}{temporisateur}
  \BAcancel{ACK}
\end{pktxdiag}

\bigskip

\begin{pktxdiag}
  \ABtimed[lost]{DATA}{3cm}{temporisateur}
  \Awaittimer
  \ABtimed{DATA}{3cm}{temporisateur}
  \BAcancel{ACK}
\end{pktxdiag}
\hfill
\begin{pktxdiag}[prop]
  \fullduplex
  \ABtimed{DATA}{2cm}{temporisateur}
  \BwaitA
  \Awaittimer
  \ABtimed{DATA}{2cm}{}
  \BAcancel{ACK}
  \BwaitA
  \BA{ACK}
\end{pktxdiag}
\caption{Stop \& Wait}
\end{figure}

\begin{figure}[H]\centering
\begin{pktxdiag}
  \AB{D0}
  \BA{ACK1}
  \AB{D1}
  \BA{ACK0}
  \AB{D0}
\end{pktxdiag}
\caption{Stop \& Wait avec numéros de séquence sur 1 bit}
\end{figure}

\subsection{HDLC}

\begin{pktxdiag}
     \ABtimed[lost]{SABME}{2cm}{T1}
     \Awaittimer
     \AB{SABME}
              \BA{UA}
\later{2cm}
     \AB{DISC}
              \BA{UA}
\end{pktxdiag}
\hfill
\begin{pktxdiag}
  \AB{I 0,0}
           \BA{I 0,1}
  \AB{I 1,1}
  \AB{I 2,1}
           \BA{I 1,3}
  \AB{I 3,2}
           \BA{I 2,4}
           \BA{I 3,4}
  \AB{RR4}
\end{pktxdiag}
\hfill
\begin{pktxdiag}
  \BA{I 3,0}
  \AB{RNR 4}
  \Bwait[1.5cm]
  \BA{RR 0,P}
  \AB{RNR 4,F}
  \Bwait[1.5cm]
  \BA{RR 0,P}
  \AB{RR 4,F}
  \BA{I 4,0}
\end{pktxdiag}

\begin{pktxdiag}
  \AB{I 3,0}
  \AB[lost]{I 4,0}
  \AB[rnote=$\times$]{I 5,0}
  \BA{REJ 4}
  \AB{I 4,0}
  \AB{I 5,0}
  \AB{I 6,0}
\end{pktxdiag}
\hfill
\begin{pktxdiag}[noteoffset=1mm]
  \fullduplex
  \AB{I 3,0}
  \BwaitA
  \BA{RR 4}
  \AB[bad]{I 4,0}
  \BwaitA \BA{SREJ 4}
  \AB[rnote=$-$]{I 5,0}
  \AB{I 4,0}
  \BwaitA \BA{RR6}
  \AB{I 6,0}
  \AB{I 7,0}
\end{pktxdiag}
\hfill
\begin{pktxdiag}
  \AB{I 2,0}
  \fullduplex
             \BA{RR3}
  \ABtimed[lost]{I 3,0}{3cm}{T1}

  \Awaittimer
  \halfduplex
  \AB{RR 0,P}
             \BA{RR 3,F}
  \AB{I 3,0}
             \BA{RR 4}
\end{pktxdiag}

\clearpage

\newcommand{\figxix}{
           \BA[id=vc1,label2={DATA 2,0 (1)}]{I 3,6}
\AB{RR 4}
           \BA[id=vc1,label2={DATA 3,0 (1)}]{I 4,6}
\AB[id=vc1,label2=RR4 (1),trans]{I 6,5}
           \BA{RR7}
           \BA[id=vc1,label2={DATA 4,0 (1)}]{I 5,7}
\AB{RR 6}
           \BA[id=vc1,label2={DATA 5,0 (1)}]{I 6,7}
}

{ \derivestyle{rr}{default}{orange}
  \derivestyle{rrl}{labeldefault}{yellow}
  \setflowstyle{main}{rr}
  \setflowlabelstyle{main}{rrl}

\begin{figure}[H]
\hfill
\subfloat[HDLC]{\begin{pktxdiag}[space other=8mm, space same=12mm]
\figxix
\end{pktxdiag}}
\hfill
\subfloat[X25]{\begin{pktxdiag}[space other=8mm, space same=12mm, hide=main,show
  label2, hide label]
\figxix
\end{pktxdiag}}
\hfill
\subfloat[HDLC/X25]{\begin{pktxdiag}[space other=8mm, space same=12mm, show label2]
\figxix
\end{pktxdiag}}
\hfill~
\caption{Décodage de la figure 19}
\end{figure}

\begin{figure}[H]
\begin{hpktxdiag}[hdlc]
\figxix
\end{hpktxdiag}

\begin{hpktxdiag}[hdlc,hide=main,show label2,hide label]
\figxix
\end{hpktxdiag}

\begin{hpktxdiag}[hdlc, show label2]
\figxix
\end{hpktxdiag}
\caption{Décodage de la figure 19}
\end{figure}
}

\begin{fhpktxdiag}[hdlc,short trans=3mm,A,B,prop=4mm]{Exercice 25}
  \AB{SABM}
           \BA{UA}
  \fullduplex
  \AB{I 0,0}
             \BwaitA
             \Bwait[4mm]
  \AB{I 1,0}
             \BA{I 0,1}
  \AB{I 2,0}
             \BA{I 1,2}
  \AB{I 3,1}
             \BA{I 2,3}
             \BA{I 3,4}
  \AwaitB
  \Await
  \AB{RR 4}
  \Await
  \AB{DISC}
  \BwaitA   \BA{UA}
\end{fhpktxdiag}

\subsection{PPP}

\begin{fpktxdiag}[A,B]{Négociation LCP}
\ABtimed{ConfReq}{3.5cm}{Négo pour A}
\BA{ConfNak}
\AB{ConfReq}
\BA{ConfAck}
\BAtimed{ConfReq}{1.5cm}{Négo pour B}
\AB{ConfAck}  
\end{fpktxdiag}

\section{NE210}

\subsection{blabla}

\begin{figure}[H]
  \centering
  \begin{pktxdiag}[A=André,B=Bertrand]
    \AB{Bonjour}
                \BA{Bonjour}
    \AB{Comment ça va ?}
                \BA{Bien et toi ?}
    \AB{Bien merci}
                \BA{Blabla}
    \AB{blabla}

\later{1cm}

    \AB{Au revoir}
                \BA{Au revoir}
  \end{pktxdiag}%% ZZZ indication du temps
  \caption{Protocole de conversation}
\end{figure}

\subsection{TFTP}

\begin{figure}[H]
\pgfkeys{/pktxd/A=C,/pktxd/B=S,/pktxd/width=2.7cm}
\subfloat[Tentative de chargement d'un fichier inexistant]{
\begin{pktxdiag}[]
  \AB{RRQ(fichier)}
  \BA{ERROR (01)}
\end{pktxdiag}}
\hfill
\subfloat[Transfert réussi d'un fichier de 1084 octets]{
\begin{pktxdiag}[A=C,B=S]
  \AB{RRQ(fichier)}
                     \BA{DATA1 (512)}
  \AB{ACK1}
                     \BA{DATA2 (512)}
  \AB{ACK2}
                     \BA[snote={< 512 octets}]{DATA3 (60)}
  \AB{ACK3}
\end{pktxdiag}}
\hfill
\subfloat[Perte d'un message pendant le transfert]{
\begin{pktxdiag}[A=C,B=S]
  \AB{RRQ(fichier)}
                     \BA{DATA1}
  \AB{ACK1}
                     \BAtimed[lost]{DATA2}{2.5cm}{}
                     \Bwaittimer
                     \BA{DATA2}
  \AB{ACK2}
                     \BA{DATA3}
  \AB{ACK3}
\end{pktxdiag}}
  \caption{TFTP}
\end{figure}

\subsection{TCP}

\begin{figure}[H]\centering
\begin{pktxdiag}
  \Astate{Closed}\Bstate{Closed}
  \Await         \Bwait
  \Await         \Bactionstate{passive open}{listen}
  \Aactionstate{active open}{SynSent}
  \AB{SYN}
                 \Bstate{SynRecvd}
                 \BA{SYN+ACK}
  \Astate{Established}
  \AB[trans]{ACK}
                 \Bstate{Established}
  \Await
\end{pktxdiag}
\caption{Ouverture de connexion}
\end{figure}

\begin{figure}[H]\centering
\begin{pktxdiag}  
  \Astate{Established}\Bstate{Established}
  \Await
  \Aactionstate{close}{FinWait1}
  \AB{FIN}
                      \Bstate{CloseWait}
                      \BA[trans]{ACK}
  \Astate{FinWait2}

\later{2cm}

                      \Bactionstate{close}{LastAck}
                      \BA{FIN}
  \Astate{TimeWait}
  \ABtimed[trans]{ACK}{5cm}{2xMSL}
                      \Bstate{Closed}
\later{2cm}
  \Awaittimer
  \Astate{Closed}
\end{pktxdiag}
\caption{Fermeture de connexion}
\end{figure}

\begin{figure}[H]
\hspace{-1cm}\subfloat[avec]{
\begin{pktxdiag}[state offset=7mm,timeri offset=3mm]
                      \Bactionstate{close}{LastAck}
                      \BAtimed{FIN}{3.5cm}{retrans}
  \Astate{TimeWait}
  \ABtimed[trans,lost]{ACK}{5cm}{2xMSL}
                      \Bwaittimer
                      \BAcancel{FIN}
  \ABtimedi[trans]{ACK}{5cm}{2xMSL}

                      \Bstate{Closed}
  \Awaittimeri
  \Astate{Closed}
\end{pktxdiag}}\hfill
\subfloat[sans]{
\begin{pktxdiag}[state offset=7mm,timeri offset=3mm]
                      \Bactionstate{close}{LastAck}
                      \BAtimed{FIN}{3.5cm}{retrans}
  \Astate{Closed}
  \AB[trans,lost,cross for lost]{ACK}
                      \Bwaittimer
                      \BA{FIN}
  \AB{RST}

                      \Bstate{Error}
\end{pktxdiag}}
  \caption{État TIME-WAIT : retransmission du FIN}
\end{figure}

\clearpage

\begin{figure}[H]
\pgfkeys{/pktxd/state offset=5mm,/pktxd/timer offset=2mm}
\hspace{-2cm}
\subfloat[un vieux FIN]{
\begin{pktxdiag}[timeri offset=3mm,width=2cm]
                      \Bactionstate{close}{LastAck}
                      \BAtimed{FIN}{3.5cm}{retrans}
  \Astate{Closed}
  \AB[late=3cm]{ACK}
                      \Bwaittimer
                      \BA[late=6cm]{FIN}
                      \Bstate{Closed}

\later{2cm}
  
                      \Bactionstate{passive open}{Listen}
  \Await
  \Aactionstate{active open}{SynSent}
  \AB{SYN}
                      \Bstate{SynRecvd}
                      \BA{SYN-ACK}
  \Astate{Established}
  \AB{ACK}
                      \Bstate{Established}
  \Awaitlate
  \Astate{CloseWait}
  \AB{ACK}
\end{pktxdiag}}
\hfill
\subfloat[un vieux DATA]{
\begin{pktxdiag}[width=2cm]
  \Astate{Established}\Bstate{Established}
  \ABtimed{DATA}{2cm}{retrans}
                     \BA[late=1cm]{ACK}
  \AB[late=11cm,dotted,rnoteoffset=1mm,rnote=oups !]{DATA} 
                     \Bactionstate{close}{FinWait1}
                     \BA{FIN}
  \Astate{CloseWait}
  \AB{ACK}
                     \Bstate{FinWait2}
  \Aactionstate{close}{LastAck}
  \AB{FIN}
                     \Bstate{Closed}
                     \BA{ACK}
  \Astate{Closed}

\later{2cm}

  \Await         \Bactionstate{passive open}{Listen}
  \Aactionstate{active open}{SynSent}
  \AB{SYN}
                 \Bstate{SynRecvd}
                 \BA{SYN-ACK}
  \Astate{Established}
  \AB{ACK}
                 \Bstate{Established}
  \Await
\end{pktxdiag}}
  \caption{Sans le TIME-WAIT : insertion de paquets retardés dans une nouvelle connexion}
\end{figure}

\begin{fpktxdiag}[width=6cm,A=Navigateur,B=Serveur]{Conversation TCP}
\NoAutoSpaceBeforeFDP

\AB[snote=segment 1]{SYN 143256:143256(0)}
  
\BA[snote=segment 2]{SYN 250712:250712(0) ACK ?}

\AB[snote=segment 3]{143257:143357(100) ACK ?}

\BA[snote=segment 4]{250713:251713(1000) ACK ?}

\AB[snote=segment 5]{FIN ?:?(?) ACK ?}
  
\BA[snote=segment 6]{ACK ?}

\BA[snote=segment 7]{FIN ?:?(?) ACK ?}

\AB[snote=segment 8]{ACK ?}
\end{fpktxdiag}

\def\width{6cm}
\begin{fpktxdiag}[prop=1cm,width=\width,A=émetteur,B=récepteur]{Contrôle de flot TCP}
  \newcommand{\buf}[3][0cm]{
    \begin{scope}[shift={(\width/2+1cm,\pBr-3.75mm-#1)},x=7.5mm]
      %% xscale so that we reason on a 4k buffer (of length 3cm)
    \draw (0,0) rectangle +(4,0.75);
    \draw[->] (#2,0.90) -- +(0,4mm);
    \draw[<-] (#3,-0.10) -- +(0,-4mm);
    \ifnum#2>#3
    \filldraw[gray!30,draw=black] (#2,0) rectangle (4,0.75);
    \filldraw[gray!30,draw=black] (0,0) rectangle (#3,0.75);
    \else
    \filldraw[gray!30,draw=black] (#2,0) rectangle (#3,0.75);
    \fi
  \end{scope}
}

\buf{0}{0}
\node at (\width/2+2.5cm,-1mm) {tampon récepteur};

\Await
\AB[snote=Appli écrit 1 k\\TCP envoie 1 k]{seq=0 (1024)}
\buf{0}{1}

\BA{ack=~~~~~~~~~~ win= }

\AB[snote=Appli écrit 4k\\TCP envoie 3 k]{seq=~~~~~~~~~~~~}
\buf{0}{4}

\BA{ack=~~~~~~~~~~ win= }
\BA[snote=Appli lit 2 k]{ack=~~~~~~~~~ win=}
\buf[2.5cm]{2}{4}

\AB[snote=TCP envoie 1 k]{seq=~~~~~~~~}
\buf{2}{1}
\BA{ack=~~~~~~~~~~ win= }
\end{fpktxdiag}


\def\ftp{
  \AB[id=tcp]{SYN}
               \BA[id=tcp]{SYN-ACK}
  \AB[id=tcp]{ACK}

               \BA{220}
  \AB{USER guest}
               \BA{331}
  \AB{PASS xxxx}
               \BA{230}
   \AB{SYST}
               \BA{215 Unix}
   \AB{PORT 192,168,130,20,217,116}
               \BA{200}
   \AB{RETR toto}
               \BA{150}

               \BA[id=data]{SYN}
   \AB[id=data]{SYN-ACK}
               \BA[id=data]{ACK}
               \BA[id=data]{data}
               \BA[id=data]{FIN}
   \AB[id=data]{ACK}
   \AB[id=data]{FIN,ACK}
               \BA[id=data]{ACK}

               \BA{226}
   \AB{QUIT}
               \BA{221}

               \BA[id=tcp]{FIN}
   \AB[id=tcp]{FIN,ACK}
               \BA[id=tcp]{ACK}
}

{
\derivestyle{data}{default}{green,line width=3pt}
\derivestyle{tcp}{default}{gray}
\setflowstyle{data}{data}
\derivestyle{tcplabel}{default}{above,blue,font=\footnotesize\ttfamily}
\setflowlabelstyle{tcp}{tcplabel}
\setflowstyle{tcp}{tcp}

\begin{pktxdiag}[width=5cm,prop=2mm]
  \ftp
\end{pktxdiag}
\begin{pktxdiag}[width=5cm,prop=2mm,hide=data,hide=tcp]
  \ftp
\end{pktxdiag}
\begin{pktxdiag}[prop=2mm,hide=main,hide=tcp]
\derivestyle{data}{default}{orange,line width=1pt}
  \ftp
\end{pktxdiag}
}
\section{NE520}


\end{document}
